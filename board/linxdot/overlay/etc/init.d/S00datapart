#!/bin/sh
#
# S00datapart - Mount pseudo-filesystems, then create/check/mount the /data partition
#

# Mount essential pseudo-filesystems first
mount -t proc proc /proc 2>/dev/null
mount -t sysfs sysfs /sys 2>/dev/null
mount -t devtmpfs devtmpfs /dev 2>/dev/null
mkdir -p /dev/pts
mount -t devpts devpts /dev/pts 2>/dev/null
mount -t tmpfs tmpfs /tmp 2>/dev/null
mount -t tmpfs tmpfs /run -o mode=0755 2>/dev/null

DATA_DEV=""

detect_data_dev() {
    root_dev=$(sed -n 's/.*root=\([^ ]*\).*/\1/p' /proc/cmdline)
    case "$root_dev" in
        /dev/mmcblk*p*)
            disk_dev="${root_dev%p*}"
            DATA_DEV="${disk_dev}p3"
            ;;
        /dev/sd*[0-9])
            disk_dev="${root_dev%[0-9]}"
            DATA_DEV="${disk_dev}3"
            ;;
        *)
            echo "S00datapart: cannot determine disk device from root=$root_dev"
            return 1
            ;;
    esac
}

case "$1" in
    start)
        detect_data_dev || exit 1

        if [ ! -b "$DATA_DEV" ]; then
            echo "S00datapart: data partition $DATA_DEV not found, skipping"
            exit 0
        fi

        echo "S00datapart: checking $DATA_DEV"
        e2fsck -pf "$DATA_DEV" 2>/dev/null

        # Resize on first boot (fast no-op if already full size)
        echo "S00datapart: resizing $DATA_DEV"
        resize2fs "$DATA_DEV" 2>/dev/null

        echo "S00datapart: mounting $DATA_DEV on /data"
        mkdir -p /data
        mount -t ext4 -o noatime "$DATA_DEV" /data

        # First boot: create skeleton directories and copy default configs
        if [ ! -f /data/.initialized ]; then
            echo "S00datapart: first boot â€” creating data skeleton"
            mkdir -p /data/docker
            mkdir -p /data/overlay/usr/upper /data/overlay/usr/work
            mkdir -p /data/overlay/var_log/upper /data/overlay/var_log/work
            mkdir -p /data/overlay/var_lib/upper /data/overlay/var_lib/work
            mkdir -p /data/overlay/etc/upper /data/overlay/etc/work
            mkdir -p /data/basicstation
            mkdir -p /data/etc

            # Copy Basics Station config files
            if [ -f /opt/basicstation/reset.sh ]; then
                cp /opt/basicstation/reset.sh /data/basicstation/
                chmod +x /data/basicstation/reset.sh
            fi

            # Create TC_KEY template for user to fill in
            if [ ! -f /data/basicstation/tc_key.txt ]; then
                cat > /data/basicstation/tc_key.txt << 'KEYEOF'
# TTN API Key for Basics Station
#
# To connect to The Things Network:
# 1. Go to https://console.cloud.thethings.network
# 2. Create or select your gateway
# 3. Generate an API key with "Link as Gateway to a Gateway Server" permission
# 4. Replace the line below with your key (delete this comment block)
#
# Example: NNSXS.XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX.YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY
KEYEOF
            fi

            touch /data/.initialized
            sync
        fi
        ;;
    stop)
        ;;
    *)
        echo "Usage: $0 {start|stop}"
        exit 1
        ;;
esac

exit 0
