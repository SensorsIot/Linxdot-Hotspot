name: Build LinxdotOS

on:
  push:
    branches: [ourOS]
    tags: ['v*']
  pull_request:
    branches: [ourOS]

env:
  BUILDROOT_VERSION: "2024.02.8"
  BUILDROOT_SHA256: "cbccfdf8483304b558f71de856867bf16e0ac542302423f6ae2217f751edee18"

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gcc g++ make patch \
            cpio unzip rsync bc wget file \
            libncurses-dev python3 perl \
            xz-utils git \
            bison flex gawk gettext texinfo \
            device-tree-compiler dosfstools mtools \
            libssl-dev

      - name: Cache Buildroot downloads
        uses: actions/cache@v4
        with:
          path: buildroot/dl
          key: buildroot-dl-${{ env.BUILDROOT_VERSION }}-${{ hashFiles('configs/linxdot_ld1001_defconfig') }}
          restore-keys: |
            buildroot-dl-${{ env.BUILDROOT_VERSION }}-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.buildroot-ccache
          key: ccache-${{ env.BUILDROOT_VERSION }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ env.BUILDROOT_VERSION }}-

      - name: Download and extract Buildroot
        run: |
          if [ ! -f buildroot/Makefile ]; then
            wget -q "https://buildroot.org/downloads/buildroot-${BUILDROOT_VERSION}.tar.xz"
            echo "${BUILDROOT_SHA256}  buildroot-${BUILDROOT_VERSION}.tar.xz" | sha256sum -c -
            tar xf "buildroot-${BUILDROOT_VERSION}.tar.xz"
            rsync -a "buildroot-${BUILDROOT_VERSION}/" buildroot/
            rm -rf "buildroot-${BUILDROOT_VERSION}"
          fi

      - name: Configure Buildroot
        run: |
          cd buildroot
          make BR2_EXTERNAL="$(pwd)/.." linxdot_ld1001_defconfig

      - name: Build
        run: |
          cd buildroot
          # Buildroot uses ~/.buildroot-ccache by default (BR2_CCACHE=y in defconfig)
          mkdir -p ~/.buildroot-ccache
          make -j$(nproc)

      - name: Validate image
        run: |
          IMG="buildroot/output/images/linxdot-basics-station.img"

          # Check image exists and has reasonable size (> 100MB)
          if [ ! -f "$IMG" ]; then
            echo "ERROR: Image file not found"
            exit 1
          fi

          SIZE=$(stat -c%s "$IMG")
          if [ "$SIZE" -lt 100000000 ]; then
            echo "ERROR: Image too small ($SIZE bytes), expected > 100MB"
            exit 1
          fi
          echo "Image size: $(numfmt --to=iec $SIZE)"

          # Verify partition table
          echo "Partition table:"
          fdisk -l "$IMG"

          # Check for expected partitions (boot, rootfs, data)
          PARTITIONS=$(fdisk -l "$IMG" 2>/dev/null | grep -c "^$IMG")
          if [ "$PARTITIONS" -lt 3 ]; then
            echo "ERROR: Expected at least 3 partitions, found $PARTITIONS"
            exit 1
          fi
          echo "Validation passed: $PARTITIONS partitions found"

      - name: Compress image
        run: |
          cd buildroot/output/images
          xz -9 -T0 -k linxdot-basics-station.img

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linxdot-emmc-image
          path: buildroot/output/images/linxdot-basics-station.img.xz
          retention-days: 30

      - name: Create release
        # Only create releases for tags on the main repo (not forks)
        if: |
          startsWith(github.ref, 'refs/tags/v') &&
          github.repository == 'SensorsIot/Linxdot-Hotspot'
        uses: softprops/action-gh-release@v2
        with:
          files: buildroot/output/images/linxdot-basics-station.img.xz
          generate_release_notes: true
